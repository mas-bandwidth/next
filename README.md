<img src="https://static.wixstatic.com/media/799fd4_0512b6edaeea4017a35613b4c0e9fc0b~mv2.jpg/v1/fill/w_1200,h_140,al_c,q_80,usm_0.66_1.00_0.01/networknext_logo_colour_black_RGB_tightc.jpg" alt="Network Next" width="600"/>

<br>

This is a monorepo that contains a WIP migration/refactor of the Network Next backend.

## Development

The toolchain used for development is kept simple to make it easy for any operating system to install and use and work out of the box for POSIX Linux distributions.

- [Docker](https://www.docker.com)
- [make](http://man7.org/linux/man-pages/man1/make.1.html)
- [sh](https://linux.die.net/man/1/sh)
- [Go](https://golang.org/dl/#stable)
- [g++](http://man7.org/linux/man-pages/man1/g++.1.html)
    - [libcurl](https://curl.haxx.se/libcurl/)
    - [libsodium](https://libsodium.gitbook.io)
    - [libpthread](https://www.gnu.org/software/hurd/libpthread.html)

### Linux

```sh
$ sudo apt install golang libsodium libcurl4-openssl-dev
```

### macOS

Install [brew](https://brew.sh)

Then:

```sh
brew install golang libsodium
```

### Windows

Using the Windows Subsystem for Linux (WSL) with Ubuntu makes it easy to work with this repo provided all the tools are installed above.

## Components

## Relay (C++)

This is the service that suppliers run on their hardware to become part of Network Next.

- Command: [`cmd/relay`](./cmd/relay)

### To Run

Run `make dev-relay`

### Environment Variables

#### Required

- `RELAY_ADDRESS`: The address of this relay, defualts to "127.0.0.1" when run using make.
- `RELAY_BACKEND_HOSTNAME`: The address of the relay backend, defaults to "http://localhost:30000" when run using make.

#### To get values for the following three variables, see [Generating Key Pairs](#generating-key-pairs)

- `RELAY_PRIVATE_KEY`: The private key of each relay.
- `RELAY_PUBLIC_KEY`: The public key of each relay generated with the private key.
- `RELAY_ROUTER_PUBLIC_KEY`: The public key of the router.

## Relay Backend (Go)

Manages the database (Redis) of connected relays and tells them which other relays to ping. Collates ping statistics received from relays into a cost matrix. Collates data in the cost matrix into a route matrix for the server backend

- Command: [`cmd/relay_backend`](./cmd/relay_backend)

### To Run

Run `make dev-relay-backend`

### Environment Variables

#### Required

To get values for the following two variables, see [Generating Key Pairs](#generating-key-pairs)

- `RELAY_KEY_PUBLIC`: The public key of each relay.
- `ROUTER_KEY_PRIVATE`: The private key of the router.

#### Optional

- `RELAY_PORT`: The port the relay backend will use.
- `REDIS_HOST`: The address of the Redis server you want to connect to.
- `CONFIGSTORE_HOST`: The address to configstore, uses the in-memory version if not supplied.
- `RELAY_MAXMIND_DB_URI`: local path to a `.mmdb` file for IP lookups. See [server backend](#server-backend-(go)) for more info.
- `RELAY_DEV`: If set, this will enable development features, like what is listed below in the [important](#important) section
- `RELAY_STUBBED_DATA_FILENAME`: Points to a json file that will be used to stub datacenter names and lat/long coords

#### IMPORTANT

If you do not set the `RELAY_MAXMIND_DB_URI` env var, you must have `RELAY_DEV` set (just exported or with a value, doesn't matter)

If you do have `RELAY_DEV` set, the backend will use a local json file to stub relay datacenter names & their latitude longitude coords.

The backend will parse the file `RELAY_STUBBED_DATA_FILENAME` points to. If the var is unset or empty, it will default to `tools/stubbed-relay-data.json`.

When using the default json file, only spawn relays with addresses & ports between the range 127.0.0.1:20000 & 127.0.0.10:20009, incrementing both the address and port at the same time, as those are the entries that exist in the file.

- Side note, the datacenter names & lat long coords were all autogenerated and thus the country state city matchup will not be accurate, nor will the lat long coords either for any of those fields.

### What it does

- Opens a couple endpoints for communication with the relays and server backend
- Takes data from the in memory StatsDatabase and generates a CostMatrix, then takes the CostMatrix and generates a RouteMatrix for the server backend once every 10 seconds

### Endpoints

- `/relay_init`: When a relay starts up, the first thing it will do is call this endpoint with its information
  - Gathers geolocation information
  - Generates the relay public keys, which is sent back in the body of the response
  - Stores the relay in redis in binary format
- `/relay_update`: After a relay has confirmation of successful initialization, it will keep sending this endpoint stats about its network timings
  - Within the response body will be a list of all other relays to ping and gather stats on

## Server (C++)

Reference implentation of a server using the Network Next SDK.

- Command: [`cmd/server`](./cmd/server)
- Dependencies: [`sdk`](./sdk)

## Server Backend (Go)

Pulls the route matrix from the relay backend once every 10 seconds and uses it to serve up routes across the relay network.

- Command: [`cmd/server_backend`](./cmd/server_backend)

### Environment Variables

#### Required

- `MAXMIND_DB_URI`: local path to a `.mmdb` file for IP lookups. Defaults to `./GeoLite2-City.mmdb`. You can ask a dev for a copy of one or register and download one from https://www.maxmind.com.

#### Optional

- `REDIS_HOST`: The address of the Redis server you want to connect to, uses the in-memory version if not supplied or invalid
- `CONFIGSTORE_HOST`: The address to configstore, uses the in-memory version if not supplied
- `ROUTE_MATRIX_URI`: The address of the Relay Backend, if empty the server backend will not pull the Route Matrix

## Client (C++)

Reference implentation of a client using the Network Next SDK.

- Command: [`cmd/client`](./cmd/client)
- Dependencies: [`sdk`](./sdk)

## SDK (C++)

This is the SDK we ship to customers.

## Tools

## relay-spawner.sh

Uses the env var `RUNNING_RELAYS` to keep track of spawned relays
- Because of that, the script must be sourced to work properly
- It will exit if you try to run the script directly

Usage: `source relay-spawner.sh` [`options`] [`starting port number`] [`ending port number`]
- Spawns relays with the port numbers between the given arguments, inclusively
- If the ending port number is not specified, one relay with the starting port number will be spawned
- `-h` to display all options

## Generating Key Pairs

Keys must be generated with Go's `box.GenerateKey()` function call. The parameter to pass is `rand.Reader`.

Generate two sets. One for relays, and one for the router. Set the following environment variables appropriately:

### Relay Environment Variables

- `RELAY_PRIVATE_KEY`
- `RELAY_PUBLIC_KEY`
- `RELAY_ROUTER_PUBLIC_KEY`

### Relay Backend Environment Variables

- `RELAY_KEY_PUBLIC`
- `RELAY_KEY_PRIVATE`
- `ROUTER_KEY_PUBLIC`
- `ROUTER_KEY_PRIVATE`

Likely the values for the three relay environment variables will be reused for the relay backend.
