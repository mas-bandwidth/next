DONE

	Now we have to work out how to track magic per-session.

	Where does magic get sent down to the client initially? Upgrade request packet?

	The current magic should get stashed in there.

	Pending session entry only needs magic, not current and pending.

	Stash the magic in there on upgrade, use the entry magic in upgrade response packet.

	Then the client should store the magic.

	Client should use the magic value when receiving packets from the server.

	Client should use the magic value when sending packets to the server.

	When the upgrade completes on the server-side, the pending entry should copy the magic to the full entry.

	The proxy entry on the server-side needs a copy of the magic from the upgrade.

TODO

	--------------

	Route update should contain current magic on server.

	--------------

	Client should stash magic in the route update when it changes, and use it right away for sends, keep old magic as prev.

	--------------

	When route update ack comes back, server moves move current -> previous, pending -> current in session.

	This way the server doesn't send a new magic until the client is guaranteed to have it.

	--------------

	The proxy entry needs to (lazily) update the magic value post-ack.

	--------------

	Client needs to accept both previous and current magic on packet read.

	--------------

	Client needs to clear magic values and external address on disconnect.

	--------------

	Client should use current magic value when sending packets to the server and relays.

	--------------

	Server should use current magic per-session (in proxy), when sending packets to a client.

	--------------

	At this point magic should theoretically be working.

	--------------






















	==================================
	Get the client/server upgrade working and the upgraded direct packets being exchanged between client and server.

	--------------

	Update the func backend 5 so it can handle new SDK5 packet types.

	--------------

	Get various upgraded direct func tests passing.

	--------------






























	========================================================

	--------------

	Work out how to get ping tokens down to the client

	--------------

	Get the client pinging near relays w. ping tokens and getting responses.

	--------------

	Update the reference relay so it can handle the new SDK5 packet types.

	--------------

	Get an actual end-to-end network next route going with SDK5 client/server.

	--------------

	Get the rest of the func tests passing.

	--------------

	=================================================

	--------------

	Move server whois to the backend, it's unreliable when run on the SDK server
	and the iteration time for fixes (new SDK deploy) is just too long.

	--------------

	We need a server flush method to timeout all sessions and flush session updates until acked.

	--------------
