<template>
  <div class="table-responsive table-no-top-line" v-if="showSessions">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>
            <span>
              Session ID
            </span>
          </th>
          <th>
            <span>
              Platform
            </span>
          </th>
          <th>
            <span>
              Connection Type
            </span>
          </th>
          <th>
            <span>
              ISP
            </span>
          </th>
          <th>
            <span>
              Datacenter
            </span>
          </th>
          <th>
            <span>
              Server Address
            </span>
          </th>
        </tr>
      </thead>
      <tbody v-if="sessions.length > 0">
        <tr id="data-row" v-for="(session, index) in sessions" v-bind:key="index">
          <td>
              <router-link v-bind:to="`/session-tool/${session.id}`" class="text-dark fixed-width">{{ session.id }}</router-link>
          </td>
          <td>
            {{ session.platform }}
          </td>
          <td>
            {{ session.connection }}
          </td>
          <td>
            {{ session.location.isp }}
          </td>
          <td>
            {{ session.datacenter }}
          </td>
          <td>
            {{ session.server_addr }}
          </td>
        </tr>
      </tbody>
      <tbody v-if="sessions.length === 0">
        <tr>
          <td colspan="7" class="text-muted">
              There are no sessions belonging to this user.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator'
import { NavigationGuardNext, Route } from 'vue-router'
import { AlertTypes } from './types/AlertTypes'

/**
 * This component displays all of the information related to the user
 *  tool page in the Portal and has all the associated logic and api calls
 */

@Component
export default class UserSessions extends Vue {
  private sessions: Array<any>
  private sessionLoop: any
  private showSessions: boolean
  private searchID: string
  private message: string
  private alertType: string

  constructor () {
    super()
    this.searchID = ''
    this.sessions = []
    this.showSessions = false
    this.sessionLoop = null
    this.message = 'Failed to fetch user sessions'
    this.alertType = AlertTypes.ERROR
  }

  private mounted () {
    this.searchID = this.$route.params.pathMatch || ''
    if (this.searchID !== '') {
      this.fetchUserSessions()
      this.sessionLoop = setInterval(() => {
        this.fetchUserSessions()
      }, 10000)
    }
  }

  private beforeRouteUpdate (to: Route, from: Route, next: NavigationGuardNext<Vue>) {
    if (this.sessionLoop) {
      clearInterval(this.sessionLoop)
    }
    this.showSessions = false
    this.searchID = to.params.pathMatch || ''
    if (this.searchID !== '') {
      this.fetchUserSessions()
      this.sessionLoop = setInterval(() => {
        this.fetchUserSessions()
      }, 10000)
    }
    next()
  }

  private fetchUserSessions () {
    if (this.searchID === '') {
      return
    }

    // TODO: Figure out how to get rid of this. this.$apiService should be possible...
    // HACK: This is a hack to get tests to work properly
    this.$apiService.fetchUserSessions({ user_id: this.searchID })
      .then((response: any) => {
        this.sessions = response.sessions || []
        this.showSessions = true
      })
      .catch((error: Error) => {
        if (this.sessionLoop) {
          clearInterval(this.sessionLoop)
        }
        if (this.sessions.length === 0) {
          this.message = 'Failed to fetch session details'
          console.log(`Something went wrong fetching sessions details for: ${this.searchID}`)
          console.log(error)
        }
        console.log(error)
      })
  }
}

</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
</style>
