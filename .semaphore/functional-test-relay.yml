version: v1.0

name: Functional Test Relay

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Functional Tests (relay)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - cd ~/accelerate
            - make clean
            - make dist/func_backend dist/func_test_relay

            - mv dist/func_backend dist/func_backend_relay

            - artifact push workflow dist/func_backend_relay
            - artifact push workflow dist/func_test_relay


  - name: "Run Functional Tests (relay) - A"
    dependencies: ["Build Functional Tests (relay)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev
            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_backend_relay
            - artifact pull workflow func_test_relay
            - artifact pull workflow relay
            - artifact pull workflow libnext5.so

            - mv func_backend_relay func_backend

            - chmod +x func_backend
            - chmod +x func_test_relay
            - chmod +x relay

            - sudo mv libnext5.so /usr/local/lib
            - sudo ldconfig

            - cd ~

      jobs:

        - name: "test_initialize_success"
          commands:
            - cd ./dist && ./func_test_relay test_initialize_success

        - name: "test_initialize_fail"
          commands:
            - cd ./dist && ./func_test_relay test_initialize_fail

        - name: "test_relay_name_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_name_not_set

        - name: "test_relay_public_address_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_address_not_set

        - name: "test_relay_public_address_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_address_invalid

        - name: "test_relay_internal_address_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_internal_address_invalid

        - name: "test_relay_public_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_key_not_set

        - name: "test_relay_public_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_key_invalid

        - name: "test_relay_private_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_private_key_not_set

        - name: "test_relay_private_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_private_key_invalid

        - name: "test_relay_keypair_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_keypair_invalid

        - name: "test_relay_backend_public_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_not_set

        - name: "test_relay_backend_public_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_invalid

        - name: "test_relay_backend_public_key_mismatch"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_mismatch

        - name: "test_relay_backend_hostname_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_hostname_not_set

        - name: "test_relay_cant_bind_to_port_zero"
          commands:
            - cd ./dist && ./func_test_relay test_relay_cant_bind_to_port_zero

        - name: "test_num_threads"
          commands:
            - cd ./dist && ./func_test_relay test_num_threads

        - name: "test_relay_pings"
          commands:
            - cd ./dist && ./func_test_relay test_relay_pings

        - name: "test_cost_matrix"
          commands:
            - cd ./dist && ./func_test_relay test_cost_matrix

        - name: "test_basic_packet_filter"
          commands:
            - cd ./dist && ./func_test_relay test_basic_packet_filter

        - name: "test_advanced_packet_filter"
          commands:
            - cd ./dist && ./func_test_relay test_advanced_packet_filter

        - name: "test_clean_shutdown"
          commands:
            - cd ./dist && ./func_test_relay test_clean_shutdown

        - name: "test_unknown_packets"
          commands:
            - cd ./dist && ./func_test_relay test_unknown_packets

        - name: "test_near_ping_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_near_ping_packet_wrong_size

        - name: "test_near_ping_packet_expired"
          commands:
            - cd ./dist && ./func_test_relay test_near_ping_packet_expired

        - name: "test_near_ping_packet_did_not_verify"
          commands:
            - cd ./dist && ./func_test_relay test_near_ping_packet_did_not_verify

        - name: "test_near_ping_packet_responded_with_pong"
          commands:
            - cd ./dist && ./func_test_relay test_near_ping_packet_responded_with_pong

        - name: "test_relay_pong_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_relay_pong_packet_wrong_size

        - name: "test_relay_ping_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_relay_ping_packet_wrong_size

        - name: "test_relay_ping_packet_expired"
          commands:
            - cd ./dist && ./func_test_relay test_relay_ping_packet_expired

        - name: "test_relay_ping_packet_did_not_verify"
          commands:
            - cd ./dist && ./func_test_relay test_relay_ping_packet_did_not_verify

        - name: "test_route_request_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_wrong_size

        - name: "test_route_request_packet_could_not_read_token"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_could_not_read_token

        - name: "test_route_request_packet_token_expired"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_token_expired

        - name: "test_route_request_packet_invalid_next_address"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_invalid_next_address

        - name: "test_route_request_packet_forward_to_next_hop_public_address"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_forward_to_next_hop_public_address

        - name: "test_route_request_packet_forward_to_next_hop_internal_address"
          commands:
            - cd ./dist && ./func_test_relay test_route_request_packet_forward_to_next_hop_internal_address

        - name: "test_route_response_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_route_response_packet_wrong_size

        - name: "test_route_response_packet_already_received"
          commands:
            - cd ./dist && ./func_test_relay test_route_response_packet_already_received

        - name: "test_route_response_packet_header_did_not_verify"
          commands:
            - cd ./dist && ./func_test_relay test_route_response_packet_header_did_not_verify

        - name: "test_route_response_packet_forward_to_previous_hop_public_address"
          commands:
            - cd ./dist && ./func_test_relay test_route_response_packet_forward_to_previous_hop_public_address

        - name: "test_route_response_packet_forward_to_previous_hop_internal_address"
          commands:
            - cd ./dist && ./func_test_relay test_route_response_packet_forward_to_previous_hop_internal_address

        - name: "test_continue_request_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_wrong_size

        - name: "test_continue_request_packet_could_not_read_token"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_could_not_read_token

        - name: "test_continue_request_packet_token_expired"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_token_expired

        - name: "test_continue_request_packet_could_not_find_session"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_could_not_find_session

        - name: "test_continue_request_packet_forward_to_next_hop_public_address"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_forward_to_next_hop_public_address

        - name: "test_continue_request_packet_forward_to_next_hop_internal_address"
          commands:
            - cd ./dist && ./func_test_relay test_continue_request_packet_forward_to_next_hop_internal_address

        - name: "test_continue_response_packet_wrong_size"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_wrong_size

        - name: "test_continue_response_packet_could_not_find_session"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_could_not_find_session


  - name: "Run Functional Tests (relay) - B"
    dependencies: ["Build Functional Tests (relay)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev
            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_backend_relay
            - artifact pull workflow func_test_relay
            - artifact pull workflow relay
            - artifact pull workflow libnext5.so

            - mv func_backend_relay func_backend

            - chmod +x func_backend
            - chmod +x func_test_relay
            - chmod +x relay

            - sudo mv libnext5.so /usr/local/lib
            - sudo ldconfig

            - cd ~

      jobs:

        - name: "test_continue_response_packet_already_received"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_already_received

        - name: "test_continue_response_packet_header_did_not_verify"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_header_did_not_verify

        - name: "test_continue_response_packet_forward_to_previous_hop_public_address"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_forward_to_previous_hop_public_address

        - name: "test_continue_response_packet_forward_to_previous_hop_internal_address"
          commands:
            - cd ./dist && ./func_test_relay test_continue_response_packet_forward_to_previous_hop_internal_address
