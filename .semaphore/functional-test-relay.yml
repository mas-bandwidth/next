version: v1.0

name: Functional Test Relay

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Functional Tests (relay)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - cd ~/accelerate
            - make clean
            - make dist/func_backend dist/func_test_relay

            - mv dist/func_backend dist/func_backend_relay

            - artifact push workflow dist/func_backend_relay
            - artifact push workflow dist/func_test_relay


  - name: "Run Functional Tests (relay)"
    dependencies: ["Build Functional Tests (relay)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev
            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_backend_relay
            - artifact pull workflow func_test_relay
            - artifact pull workflow relay
            - artifact pull workflow libnext5.so

            - mv func_backend_relay func_backend

            - chmod +x func_backend
            - chmod +x func_test_relay
            - chmod +x relay

            - sudo mv libnext5.so /usr/local/lib
            - sudo ldconfig

            - cd ~

      jobs:

        - name: "test_initialize_success"
          commands:
            - cd ./dist && ./func_test_relay test_initialize_success

        - name: "test_initialize_fail"
          commands:
            - cd ./dist && ./func_test_relay test_initialize_fail

        - name: "test_relay_name_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_name_not_set

        - name: "test_relay_public_address_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_address_not_set

        - name: "test_relay_public_address_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_address_invalid

        - name: "test_relay_internal_address_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_internal_address_invalid

        - name: "test_relay_public_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_key_not_set

        - name: "test_relay_public_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_public_key_invalid

        - name: "test_relay_private_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_private_key_not_set

        - name: "test_relay_private_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_private_key_invalid

        - name: "test_relay_keypair_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_keypair_invalid

        - name: "test_relay_backend_public_key_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_not_set

        - name: "test_relay_backend_public_key_invalid"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_invalid

        - name: "test_relay_backend_public_key_mismatch"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_public_key_mismatch

        - name: "test_relay_backend_hostname_not_set"
          commands:
            - cd ./dist && ./func_test_relay test_relay_backend_hostname_not_set

        - name: "test_relay_cant_bind_to_port_zero"
          commands:
            - cd ./dist && ./func_test_relay test_relay_cant_bind_to_port_zero

        - name: "test_relay_num_threads"
          commands:
            - cd ./dist && ./func_test_relay test_relay_num_threads
