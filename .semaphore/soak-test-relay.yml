version: v1.0

name: Soak Test Relay

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Soak Test (relay)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - cd ~/accelerate
            - make clean
            - make dist/func_backend dist/soak_test_relay

            - mv dist/func_backend dist/func_backend_soak_test_relay

            - artifact push workflow dist/func_backend_soak_test_relay
            - artifact push workflow dist/soak_test_relay


  - name: "Run Soak Test (relay)"
    dependencies: ["Build Soak Test (relay)"]
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev
            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_backend_soak_test_relay
            - artifact pull workflow soak_test_relay
            - artifact pull workflow relay-debug
            - artifact pull workflow libnext.so

            - mv func_backend_soak_test_relay func_backend

            - chmod +x func_backend
            - chmod +x soak_test_relay
            - chmod +x relay-debug

            - cd ~

      jobs:

        - name: "soak"
          commands:
            - cd ./dist && ./soak_test_relay stop
