version: v1.0

name: "Development Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: sdk5-repo-access
    - name: google-cloud-platform
  prologue:
    commands:
      - checkout
      - cp envs/local.env .env

blocks:

  - name: "Publish Artifacts"

    dependencies: ["Build Artifacts (Scripts)", "Build Artifacts (Golang)", "Build Artifacts (Native)"]

    task:

      prologue:
        commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json

      jobs:

        - name: "Bootstrap"
          commands:
            - artifact pull workflow bootstrap.sh
            - gsutil cp bootstrap.sh gs://development_artifacts/

        - name: "Analytics"
          commands:
            - artifact pull workflow analytics.dev.tar.gz
            - gsutil cp analytics.dev.tar.gz gs://development_artifacts/

        - name: "Portal"
          commands:
            - artifact pull workflow portal.dev.tar.gz
            - gsutil cp portal.dev.tar.gz gs://development_artifacts/

        - name: "Portal Cruncher"
          commands:
            - artifact pull workflow portal_cruncher.dev.tar.gz
            - gsutil cp portal_cruncher.dev.tar.gz gs://development_artifacts/

        - name: "Relay Gateway"
          commands:
            - artifact pull workflow relay_gateway.dev.tar.gz
            - gsutil cp relay_gateway.dev.tar.gz gs://development_artifacts/

        - name: "Relay Backend"
          commands:
            - artifact pull workflow relay_backend.dev.tar.gz
            - gsutil cp relay_backend.dev.tar.gz gs://development_artifacts/

        - name: "Server Backend 5"
          commands:
            - artifact pull workflow server_backend5.dev.tar.gz
            - gsutil cp server_backend5.dev.tar.gz gs://development_artifacts/

        - name: "Sync"
          commands:
            - artifact pull workflow sync.dev.tar.gz
            - gsutil cp sync.dev.tar.gz gs://development_artifacts/

        - name: "Pingdom"
          commands:
            - artifact pull workflow pingdom.dev.tar.gz
            - gsutil cp pingdom.dev.tar.gz gs://development_artifacts/

        - name: "Magic Backend"
          commands:
            - artifact pull workflow magic_backend.dev.tar.gz
            - gsutil cp magic_backend.dev.tar.gz gs://development_artifacts/

        - name: "Redis Monitor"
          commands:
            - artifact pull workflow redis_monitor.dev.tar.gz
            - gsutil cp redis_monitor.dev.tar.gz gs://development_artifacts/

        - name: "Website Cruncher"
          commands:
            - artifact pull workflow website_cruncher.dev.tar.gz
            - gsutil cp website_cruncher.dev.tar.gz gs://development_artifacts/

        - name: "Raspberry Backend"
          commands:
            - artifact pull workflow raspberry_backend.dev.tar.gz
            - gsutil cp raspberry_backend.dev.tar.gz gs://development_artifacts/

        - name: "Raspberry Server"
          commands:
            - artifact pull workflow raspberry_server.dev.tar.gz
            - gsutil cp raspberry_server.dev.tar.gz gs://development_artifacts/

        - name: "Raspberry Client"
          commands:
            - artifact pull workflow raspberry_client.dev.tar.gz
            - gsutil cp raspberry_client.dev.tar.gz gs://development_artifacts/

        - name: "Sodium"
          commands:
            - artifact pull workflow libsodium.so
            - gsutil cp libsodium.so gs://development_artifacts/libsodium.so

        - name: "SDK4"
          commands:
            - artifact pull workflow libnext4.so
            - gsutil cp libnext4.so gs://development_artifacts/libnext4.so

        - name: "SDK5"
          commands:
            - artifact pull workflow libnext5.so
            - gsutil cp libnext5.so gs://development_artifacts/libnext5.so

        - name: "Reference Relay"
          commands:
            - artifact pull workflow reference_relay
            - gsutil cp reference_relay gs://development_artifacts/reference_relay
            - gsutil cp reference_relay gs://relay_artifacts/relay-reference
