version: v1.0

name: "Development Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: google-cloud-platform

blocks:

  - name: "Publish Artifacts"

    task:

      prologue:
        commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
            - export DEV_BUCKET=gs://network_next_dev_artifacts/
            - export RELAY_BUCKET=gs://network_next_relay_artifacts/

      jobs:

        - name: "Bootstrap"
          commands:
            - artifact pull workflow bootstrap.sh
            - gsutil cp bootstrap.sh $DEV_BUCKET

        - name: "Sodium"
          commands:
            - artifact pull workflow libsodium.so
            - gsutil cp libsodium.so $DEV_BUCKET

        - name: "Analytics"
          commands:
            - artifact pull workflow analytics.tar.gz
            - gsutil cp analytics.tar.gz $DEV_BUCKET

        - name: "API"
          commands:
            - artifact pull workflow api.tar.gz
            - gsutil cp api.tar.gz $DEV_BUCKET

        - name: "Map Cruncher"
          commands:
            - artifact pull workflow map_cruncher.tar.gz
            - gsutil cp map_cruncher.tar.gz $DEV_BUCKET

        - name: "Portal Cruncher"
          commands:
            - artifact pull workflow portal_cruncher.tar.gz
            - gsutil cp portal_cruncher.tar.gz $DEV_BUCKET

        - name: "Relay Gateway"
          commands:
            - artifact pull workflow relay_gateway.tar.gz
            - gsutil cp relay_gateway.tar.gz $DEV_BUCKET

        - name: "Relay Backend"
          commands:
            - artifact pull workflow relay_backend.tar.gz
            - gsutil cp relay_backend.tar.gz $DEV_BUCKET

        - name: "Server Backend"
          commands:
            - artifact pull workflow server_backend.tar.gz
            - gsutil cp server_backend.tar.gz $DEV_BUCKET

        - name: "Magic Backend"
          commands:
            - artifact pull workflow magic_backend.tar.gz
            - gsutil cp magic_backend.tar.gz $DEV_BUCKET

        - name: "Raspberry Backend"
          commands:
            - artifact pull workflow raspberry_backend.tar.gz
            - gsutil cp raspberry_backend.tar.gz $DEV_BUCKET

        - name: "Raspberry Server"
          commands:
            - artifact pull workflow raspberry_server.tar.gz
            - gsutil cp raspberry_server.tar.gz $DEV_BUCKET

        - name: "Raspberry Client"
          commands:
            - artifact pull workflow raspberry_client.tar.gz
            - gsutil cp raspberry_client.tar.gz $DEV_BUCKET

        - name: "Relay"
          commands:
            - artifact pull workflow relay
            - chmod +x relay
            - export VERSION=`./relay version`
            - mv relay relay-$VERSION
            - gsutil cp relay-$VERSION $RELAY_BUCKET
