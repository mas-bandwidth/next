version: v1.0

name: "Deploy to Production"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: terraform-prod
    - name: terraform-cloudflare

blocks:

  - name: "Deploy to Production"

    task:

      jobs:
        - name: "Deploy"
          commands:
            - export GOOGLE_APPLICATION_CREDENTIALS=/home/semaphore/secrets/terraform-prod.json
            - gcloud auth activate-service-account --key-file=/home/semaphore/secrets/terraform-prod.json
            - echo $SEMAPHORE_GIT_TAG_NAME
            - echo $SEMAPHORE_GIT_BRANCH
            - echo $SEMAPHORE_WORKFLOW_NUMBER
            - checkout
            - cd terraform/prod/backend
            - terraform init
            - terraform apply -var="tag=${SEMAPHORE_GIT_TAG_NAME}" -var="extra=-${SEMAPHORE_WORKFLOW_NUMBER}" -auto-approve -lock=false
