version: v1.0

name: "Relay Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: secrets

blocks:

  - name: "Publish Artifacts"

    task:

      prologue:
        commands:
            - tar xzf /home/semaphore/secrets/secrets.tar.gz -C /home/semaphore/secrets
            - gcloud auth activate-service-account --key-file=/home/semaphore/secrets/terraform-storage.json
            - export RELAY_BUCKET=gs://alocasia_network_next_relay_artifacts

      jobs:

        - name: "Relay (debug)"
          commands:
            - artifact pull workflow relay-debug
            - chmod +x relay-debug
            - export VERSION=`./relay-debug version`
            - mv relay-debug relay-debug-$VERSION
            - gsutil cp relay-debug-$VERSION $RELAY_BUCKET

        - name: "Relay (release)"
          commands:
            - artifact pull workflow relay-release
            - chmod +x relay-release
            - export VERSION=`./relay-release version`
            - mv relay-release relay-release-$VERSION
            - gsutil cp relay-release-$VERSION $RELAY_BUCKET
