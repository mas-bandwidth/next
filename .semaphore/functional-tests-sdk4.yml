version: v1.0

name: Functional Tests (SDK4)

fail_fast:
  stop:
    when: "true"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Functional Tests (sdk4)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - cd ~/backend
            - make clean
            - make func-test-sdk4

            - artifact push workflow dist/func_client4
            - artifact push workflow dist/func_server4
            - artifact push workflow dist/func_backend4
            - artifact push workflow dist/func_tests_sdk4


  - name: "Run Functional Tests (sdk4)"
    dependencies: ["Build Functional Tests (sdk4)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev
            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_client4
            - artifact pull workflow func_server4
            - artifact pull workflow func_backend4
            - artifact pull workflow func_tests_sdk4
            - artifact pull workflow reference_relay
            - artifact pull workflow libnext4.so
            - artifact pull workflow libsodium.so

            - chmod +x func_client4
            - chmod +x func_server4
            - chmod +x func_backend4
            - chmod +x func_tests_sdk4
            - chmod +x reference_relay

            - sudo mv libsodium.so /usr/local/lib
            - sudo mv libnext4.so /usr/local/lib
            - sudo ldconfig

            - cd ~

      jobs:

        - name: "test_direct_raw"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_direct_raw

        - name: "test_direct_upgraded"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_direct_upgraded

        - name: "test_network_next_route"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_network_next_route

        - name: "test_fallback_to_direct_backend"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_fallback_to_direct_backend

        - name: "test_fallback_to_direct_client_side"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_fallback_to_direct_client_side

        - name: "test_fallback_to_direct_server_restart"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_fallback_to_direct_server_restart

        - name: "test_disable_on_server"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_disable_on_server

        - name: "test_disable_on_client"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_disable_on_client

        - name: "test_route_switching"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_route_switching

        - name: "test_on_off"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_on_off

        - name: "test_on_on_off"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_on_on_off

        - name: "test_reconnect_direct"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_reconnect_direct

        - name: "test_reconnect_direct_no_upgrade"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_reconnect_direct_no_upgrade

        - name: "test_reconnect_next"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_reconnect_next

        - name: "test_connect_to_another_server_direct"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_connect_to_another_server_direct

        - name: "test_connect_to_another_server_next"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_connect_to_another_server_next

        - name: "test_multipath"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_multipath

        - name: "test_multipath_next_packet_loss"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_multipath_next_packet_loss

        - name: "test_multipath_fallback_to_direct"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_multipath_fallback_to_direct

        - name: "test_uncommitted"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_uncommitted

        - name: "test_uncommitted_to_committed"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_uncommitted_to_committed

        - name: "test_packet_loss_direct"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_packet_loss_direct

        - name: "test_packet_loss_next"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_packet_loss_next

        - name: "test_server_under_load"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_server_under_load

        - name: "test_session_update_retry"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_session_update_retry

        - name: "test_bandwidth_over_limit"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_bandwidth_over_limit

        - name: "test_packet_loss"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_packet_loss

        - name: "test_bandwidth"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_bandwidth

        - name: "test_jitter"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_jitter

        - name: "test_tags"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_tags

        - name: "test_tags_multi"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_tags_multi

        - name: "test_direct_stats"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_direct_stats

        - name: "test_next_stats"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_next_stats

        - name: "test_report_session"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_report_session

        - name: "test_client_ping_timed_out"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_client_ping_timed_out

        - name: "test_server_events"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_server_events

        - name: "test_match_id"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_match_id

        - name: "test_match_values"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_match_values

        - name: "test_match_data_retry"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_match_data_retry

        - name: "test_flush"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_flush

        - name: "test_flush_retry"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_flush_retry

        - name: "test_flush_server_events_and_match_data"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_flush_server_events_and_match_data

        - name: "test_flush_server_events_and_match_data_retry"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_flush_server_events_and_match_data_retry

        - name: "test_big_packets"
          commands:
            - cd ./dist && ./func_tests_sdk4 test_big_packets
