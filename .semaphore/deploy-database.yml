version: v1.0

name: "Database Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: google-cloud-platform

blocks:

  - name: "Publish Database"

    task:

      jobs:

        - name: "database.bin"
          commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
            - export ARTIFACT_BUCKET=gs://${COMPANY_NAME}_network_next_${SEMAPHORE_GIT_BRANCH}_artifacts/
            - sem-service start postgres 14
            - sem-service status postgres
            - psql -U postgres -h localhost -c "CREATE USER developer;"
            - psql -U postgres -h localhost -c "ALTER USER developer WITH SUPERUSER;"
            - cache restore golang
            - checkout
            - sudo apt-get install -y libsodium-dev
            - cd ~/accelerate
            - ./next select ${SEMAPHORE_GIT_BRANCH}
            - ./run sql-create
            - ./run sql-${SEMAPHORE_GIT_BRANCH}
            - ./run extract-database
            - gsutil cp database.bin $ARTIFACT_BUCKET
