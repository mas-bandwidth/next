version: v1.0
name: Production Deploy
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
global_job_config:
  prologue:
    commands:
      - sudo apt-get update && sudo apt-get -y install libsodium-dev
      - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
      - gcloud auth configure-docker -q
      - checkout
      - sem-version go 1.13
      - make clean
blocks:
  - name: Build
    dependencies: []
    task:
      jobs:
        - name: Build Billing
          commands:
            - make build-billing-prod-artifact
            - artifact push workflow ./dist/billing.prod.tar.gz
        - name: Build Portal
          commands:
            - make build-portal-prod-artifact
            - artifact push workflow ./dist/portal.prod.tar.gz
        - name: Build Relay Backend
          commands:
            - make build-relay-backend-prod-artifact
            - artifact push workflow ./dist/relay_backend.prod.tar.gz
        - name: Build Server Backend
          commands:
            - make build-server-backend-prod-artifact
            - artifact push workflow ./dist/server_backend.prod.tar.gz
  - name: Publish
    dependencies: ["Build"]
    task:
      jobs:
        - name: Publish Billing
          commands:
            - artifact pull workflow ./dist/billing.prod.tar.gz
            - make publish-billing-prod-artifact
        - name: Publish Portal
          commands:
            - artifact pull workflow ./dist/portal.prod.tar.gz
            - make publish-portal-prod-artifact
        - name: Publish Relay Backend
          commands:
            - artifact pull workflow ./dist/relay_backend.prod.tar.gz
            - make publish-relay-backend-prod-artifact
        - name: Publish Server Backend
          commands:
            - artifact pull workflow ./dist/server_backend.prod.tar.gz
            - make publish-server-backend-prod-artifact
        - name: Publish Bootstrap Script
          commands:
            - make publish-bootstrap-script-prod
      secrets:
        - name: google-cloud-platform-prod