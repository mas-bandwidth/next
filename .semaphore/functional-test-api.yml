version: v1.0

name: Functional Test API

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Functional Tests (api)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - cache restore golang

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - make clean
            
            - make -j dist/api dist/func_test_api

            - tar -zcvf functional_test_api.tar.gz dist/api dist/func_test_api schemas/sql/create.sql schemas/sql/destroy.sql

            - artifact push workflow functional_test_api.tar.gz

  - name: "Run Functional Tests (api)"
    dependencies: ["Build Functional Tests (api)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sem-service start postgres 14
            - sem-service status postgres
            - psql -U postgres -h localhost -c "CREATE USER developer;"
            - psql -U postgres -h localhost -c "ALTER USER developer WITH SUPERUSER;"

            - sudo apt-get install -y libsodium-dev

            - artifact pull workflow functional_test_api.tar.gz

            - tar -zxf functional_test_api.tar.gz

            - chmod +x ./dist/api
            - chmod +x ./dist/func_test_api

      jobs:

        - name: "test_customer"
          commands:
            - cd ./dist && ./func_test_api test_customer

        - name: "test_buyer"
          commands:
            - cd ./dist && ./func_test_api test_buyer

        - name: "test_seller"
          commands:
            - cd ./dist && ./func_test_api test_seller

        - name: "test_datacenter"
          commands:
            - cd ./dist && ./func_test_api test_datacenter

        - name: "test_relay"
          commands:
            - cd ./dist && ./func_test_api test_relay

        - name: "test_route_shader"
          commands:
            - cd ./dist && ./func_test_api test_route_shader

        - name: "test_buyer_datacenter_settings"
          commands:
            - cd ./dist && ./func_test_api test_buyer_datacenter_settings
