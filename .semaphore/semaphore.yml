version: v1.0

name: Test

fail_fast:
  stop:
    when: "true"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: sdk5-repo-access
    - name: google-cloud-platform

blocks:

  - name: "Dependencies"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Build Sodium"
          commands:

            - checkout

            - cd ~/backend/libs/sodium
            - ./configure
            - make -j
            - sudo make -j install
            - sudo ldconfig
            - artifact push workflow /usr/local/lib/libsodium.so

  - name: "Backend"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:

        - name: "Unit Tests"

          commands:

            - checkout
            - cp envs/local.env .env
            - sudo apt-get install -y libsodium-dev

            - cd ~/backend
            - ./run test
            - cache store

  - name: "SDK4"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cp envs/local.env .env
            - export LD_LIBRARY_PATH=.
            - mkdir dist
            - make dist/test4
            - ./run test-sdk4

  - name: "SDK5"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cp envs/local.env .env
            - export LD_LIBRARY_PATH=.
            - mkdir dist
            - make dist/test5
            - ./run test-sdk5


  - name: "Build Artifacts (Scripts)"

    dependencies: []

    task:

      jobs:

        - name: "Bootstrap"
          commands:
            - checkout
            - artifact push workflow deploy/bootstrap.sh


  - name: "Build Artifacts (Golang)"

    dependencies: []

    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      prologue:
        commands:

            - checkout

            - cd ~/backend/libs/sodium
            - ./configure
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig

            - cd ~/backend

            - cache restore

      jobs:

        - name: "Analytics"
          commands:
            - make dist/analytics.dev.tar.gz
            - artifact push workflow dist/analytics.dev.tar.gz

        - name: "Portal"
          commands:
            - make dist/portal.dev.tar.gz
            - artifact push workflow dist/portal.dev.tar.gz

        - name: "Portal Cruncher"
          commands:
            - make dist/portal_cruncher.dev.tar.gz
            - artifact push workflow dist/portal_cruncher.dev.tar.gz

        - name: "Relay Gateway"
          commands:
            - make dist/relay_gateway.dev.tar.gz
            - artifact push workflow dist/relay_gateway.dev.tar.gz

        - name: "Relay Backend"
          commands:
            - make dist/relay_backend.dev.tar.gz
            - artifact push workflow dist/relay_backend.dev.tar.gz

        - name: "Server Backend 5"
          commands:
            - make dist/server_backend5.dev.tar.gz
            - artifact push workflow dist/server_backend5.dev.tar.gz

        - name: "Sync"
          commands:
            - make dist/sync.dev.tar.gz
            - artifact push workflow dist/sync.dev.tar.gz

        - name: "Pingdom"
          commands:
            - make dist/pingdom.dev.tar.gz
            - artifact push workflow dist/pingdom.dev.tar.gz

        - name: "Magic Backend"
          commands:
            - make dist/magic_backend.dev.tar.gz
            - artifact push workflow dist/magic_backend.dev.tar.gz

        - name: "Redis Monitor"
          commands:
            - make dist/redis_monitor.dev.tar.gz
            - artifact push workflow dist/redis_monitor.dev.tar.gz

        - name: "Website Cruncher"
          commands:
            - make dist/website_cruncher.dev.tar.gz
            - artifact push workflow dist/website_cruncher.dev.tar.gz

        - name: "Raspberry Backend"
          commands:
            - make dist/raspberry_backend.dev.tar.gz
            - artifact push workflow dist/raspberry_backend.dev.tar.gz


  - name: "Build Artifacts (Native)"

    dependencies: []

    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      prologue:
        commands:
            - sudo apt-get update
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update
            - mkdir dist

      jobs:

        - name: "Raspberry Server"
          commands:
            - artifact pull workflow libnext5.so
            - make -j dist/raspberry_server.dev.tar.gz
            - artifact push workflow dist/raspberry_server.dev.tar.gz

        - name: "Raspberry Client"
          commands:
            - artifact pull workflow libnext5.so
            - make -j dist/raspberry_client.dev.tar.gz
            - artifact push workflow dist/raspberry_client.dev.tar.gz

        - name: "Build Reference Relay"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cp envs/local.env .env
            - mkdir dist
            - make dist/reference_relay
            - artifact push workflow ./dist/reference_relay


promotions:

  - name: "Development Deployment"
    pipeline_file: development-deploy.yml
    auto_promote:
      when: branch = 'dev' AND result = 'passed'
