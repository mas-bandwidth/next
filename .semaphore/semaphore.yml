version: v1.0

name: Test

agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: sdk5-repo-access
  prologue:
    commands:
      - checkout
      - cp envs/local.env .env

blocks:

  - name: "Backend"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
        containers:
          - name: main
            image: nbopardi/networknext:backend
      jobs:
        - name: "Unit Tests"
          commands:
            - make test
      env_vars:
        - name: PUBSUB_EMULATOR_HOST
          value: "127.0.0.1:12000"
        - name: BIGTABLE_EMULATOR_HOST
          value: "127.0.0.1:8086"

  - name: "SDK4"
    dependencies: []
    task:
      prologue:
        commands:
          - sudo apt-get update
          - sudo apt-get install -y libsodium-dev
          - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
          - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
          - git submodule init
          - git submodule update
      jobs:
        - name: "Unit Tests"
          commands:
            - make -j32 test-sdk4

  - name: "SDK5"
    dependencies: []
    task:

      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get update
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update
            - make -j32 test-sdk5

    test_passthrough,
    test_direct_upgraded,
    test_network_next_route,
    test_fallback_to_direct_backend,
    test_fallback_to_direct_client_side,
    test_fallback_to_direct_server_restart,
    test_disable_on_server,
    test_disable_on_client,
    test_route_switching,
    test_on_off,
    test_on_on_off,
    test_reconnect_direct,
    test_reconnect_direct_no_upgrade,
    test_reconnect_next,
    test_connect_to_another_server_direct,
    test_connect_to_another_server_next,
    test_multipath,
    test_multipath_next_packet_loss,
    test_multipath_fallback_to_direct,
    test_uncommitted,
    test_uncommitted_to_committed,
    test_packet_loss_direct,
    test_packet_loss_next,
    test_server_under_load,
    test_session_update_retry,
    test_bandwidth_over_limit,
    test_packet_loss,
    test_bandwidth,
    test_jitter,
    test_tags,
    test_tags_multi,
    test_direct_stats,
    test_next_stats,
    test_report_session,
    test_client_ping_timed_out,
    test_server_ready_success,
    test_server_ready_fallback_to_direct,
    test_server_ready_autodetect_cloud,
    test_server_ready_autodetect_multiplay_success,
    test_server_ready_autodetect_multiplay_fail,
    test_server_ready_disable_autodetect_cloud,
    test_server_ready_disable_autodetect_multiplay,
    test_server_ready_resolve_hostname_timeout,
    test_server_ready_autodetect_timeout,
    test_client_connect_before_ready,
    test_server_events,
    test_match_id,
    test_match_values,
    test_match_data_retry,
    test_flush,
    test_flush_retry,
    test_flush_server_events_and_match_data,
    test_flush_server_events_and_match_data_retry,

  - name: "Relay"
    dependencies: []
    task:
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get update
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update
            - make -j32 test-relay

promotions:

  - name: "Development Deployment"
    pipeline_file: development-deploy.yml
    auto_promote:
      when: branch = 'dev' AND result = 'passed'
  
  - name: "Staging Deployment"
    pipeline_file: staging-deploy.yml
    auto_promote:
      when: branch = 'staging' AND result = 'passed'
  
  - name: "Production Deployment"
    pipeline_file: production-deploy.yml
    auto_promote:
      when: branch = 'prod' AND result = 'passed'
  
  - name: "Production Debug Deployment"
    pipeline_file: production-debug-deploy.yml
    auto_promote:
      when: branch = 'prod_debug' AND result = 'passed'
