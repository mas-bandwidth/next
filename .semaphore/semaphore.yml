version: v1.0

name: Test

agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: sdk5-repo-access
  prologue:
    commands:
      - checkout
      - cp envs/local.env .env

blocks:

  - name: "Unit Tests"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
        containers:
          - name: main
            image: nbopardi/networknext:backend
      jobs:
        - name: Run Tests
          commands:
            - make test
      env_vars:
        - name: PUBSUB_EMULATOR_HOST
          value: "127.0.0.1:12000"
        - name: BIGTABLE_EMULATOR_HOST
          value: "127.0.0.1:8086"

  - name: "Build SDK4 on Linux"
    dependencies: []
    task:
      jobs:
        - name: "Build SDK4"
          commands:
            - sudo apt-get update
            - sudo apt-get install -y libsodium-dev
            - git submodule init
            - git submodule update
            - make -j32 build-sdk4

  - name: "Build SDK4 on Mac"
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-xcode13
      jobs:
        - name: "Build SDK4"
          commands:
            - brew install libsodium
            - git submodule init
            - git submodule update
            - make -j32 build-sdk4

  - name: "Build SDK5 on Linux"
    dependencies: []
    task:
      jobs:
        - name: "Build SDK5"
          commands:
            - sudo apt-get update
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update
            - make -j32 build-sdk5

  - name: "Build SDK5 on Mac"
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-xcode13
      jobs:
        - name: "Build SDK5"
          commands:
            - brew install libsodium
            - git submodule init
            - git submodule update
            - make -j32 build-sdk5
