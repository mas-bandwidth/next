version: v1.0

name: "Backend Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: google-cloud-platform

blocks:

  - name: "Publish Artifacts"

    task:

      prologue:
        commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
            - export ARTIFACT_BUCKET=gs://network_next_${SEMAPHORE_GIT_BRANCH}_artifacts/

      jobs:
        - name: "Bootstrap"
          commands:
            - artifact pull workflow bootstrap.sh
            - gsutil cp bootstrap.sh $ARTIFACT_BUCKET

        - name: "Sodium"
          commands:
            - artifact pull workflow libsodium.so
            - gsutil cp libsodium.so $ARTIFACT_BUCKET

        - name: "SDK"
          commands:
            - artifact pull workflow libnext5.so
            - gsutil cp libnext5.so $ARTIFACT_BUCKET

        - name: "Analytics"
          commands:
            - artifact pull workflow analytics.tar.gz
            - gsutil cp analytics.tar.gz $ARTIFACT_BUCKET

        - name: "API"
          commands:
            - artifact pull workflow api.tar.gz
            - gsutil cp api.tar.gz $ARTIFACT_BUCKET

        - name: "Map Cruncher"
          commands:
            - artifact pull workflow map_cruncher.tar.gz
            - gsutil cp map_cruncher.tar.gz $ARTIFACT_BUCKET

        - name: "Portal Cruncher"
          commands:
            - artifact pull workflow portal_cruncher.tar.gz
            - gsutil cp portal_cruncher.tar.gz $ARTIFACT_BUCKET

        - name: "Relay Gateway"
          commands:
            - artifact pull workflow relay_gateway.tar.gz
            - gsutil cp relay_gateway.tar.gz $ARTIFACT_BUCKET

        - name: "Relay Backend"
          commands:
            - artifact pull workflow relay_backend.tar.gz
            - gsutil cp relay_backend.tar.gz $ARTIFACT_BUCKET

        - name: "Server Backend"
          commands:
            - artifact pull workflow server_backend.tar.gz
            - gsutil cp server_backend.tar.gz $ARTIFACT_BUCKET

        - name: "Magic Backend"
          commands:
            - artifact pull workflow magic_backend.tar.gz
            - gsutil cp magic_backend.tar.gz $ARTIFACT_BUCKET

        - name: "UDP"
          commands:
            - artifact pull workflow udp.tar.gz
            - gsutil cp udp.tar.gz $ARTIFACT_BUCKET

        - name: "Raspberry Backend"
          commands:
            - artifact pull workflow raspberry_backend.tar.gz
            - gsutil cp raspberry_backend.tar.gz $ARTIFACT_BUCKET

        - name: "Raspberry Server"
          commands:
            - artifact pull workflow raspberry_server.tar.gz
            - gsutil cp raspberry_server.tar.gz $ARTIFACT_BUCKET

        - name: "Raspberry Client"
          commands:
            - artifact pull workflow raspberry_client.tar.gz
            - gsutil cp raspberry_client.tar.gz $ARTIFACT_BUCKET
