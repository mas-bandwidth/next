version: v1.0

name: "Staging Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: google-cloud-platform

blocks:

  - name: "Publish Artifacts"

    task:

      prologue:
        commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
            - export STAGING_BUCKET=gs://network_next_staging_artifacts/

      jobs:

        - name: "Bootstrap"
          commands:
            - artifact pull workflow bootstrap.sh
            - gsutil cp bootstrap.sh $STAGING_BUCKET

        - name: "Sodium"
          commands:
            - artifact pull workflow libsodium.so
            - gsutil cp libsodium.so $STAGING_BUCKET

        - name: "SDK"
          commands:
            - artifact pull workflow libnext5.so
            - gsutil cp libnext5.so $STAGING_BUCKET

        - name: "Analytics"
          commands:
            - artifact pull workflow analytics.tar.gz
            - gsutil cp analytics.tar.gz $STAGING_BUCKET

        - name: "API"
          commands:
            - artifact pull workflow api.tar.gz
            - gsutil cp api.tar.gz $STAGING_BUCKET

        - name: "Map Cruncher"
          commands:
            - artifact pull workflow map_cruncher.tar.gz
            - gsutil cp map_cruncher.tar.gz $STAGING_BUCKET

        - name: "Portal Cruncher"
          commands:
            - artifact pull workflow portal_cruncher.tar.gz
            - gsutil cp portal_cruncher.tar.gz $STAGING_BUCKET

        - name: "Relay Gateway"
          commands:
            - artifact pull workflow relay_gateway.tar.gz
            - gsutil cp relay_gateway.tar.gz $STAGING_BUCKET

        - name: "Relay Backend"
          commands:
            - artifact pull workflow relay_backend.tar.gz
            - gsutil cp relay_backend.tar.gz $STAGING_BUCKET

        - name: "Server Backend"
          commands:
            - artifact pull workflow server_backend.tar.gz
            - gsutil cp server_backend.tar.gz $STAGING_BUCKET

        - name: "Magic Backend"
          commands:
            - artifact pull workflow magic_backend.tar.gz
            - gsutil cp magic_backend.tar.gz $STAGING_BUCKET
